<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="white" />
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon.png">
    <title>Exam questions</title>
    <style>
      * {
        font-family: Arial, sans-serif;
      }
      body {
        height: 100%;
      }
      div.hidden {
        display: none
      }
      button {
        margin: 5px;
        background-color: white;
        border: 1px solid black;
        padding: 15px 32px;
        text-align: center;
        text-decoration: none;
        cursor: pointer;
        display: inline-block;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
      }
      button:hover {
        box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.2);
      }
      button:disabled {
        background-color: #b7b7b7;
        box-shadow: 0 0 0 0 black;
        color: white;
        cursor: default;
      }
      header {
        position: fixed;
        background-color: white;
        top: 0;
        right: 0;
        width: 100%;
        box-shadow: 0 8px 8px 0 rgba(0, 0, 0, 0.2);
      }
      header button {
        padding: 5px 8px;
      }
      header p {
        margin: 10px 30px;
      }
      .question {
        display: block;
        border: 1px solid black;
        padding: 10px;
        margin: 10px;
      }
      .editQuestion > * {
        display: block;
        width: 90%;
        margin-left: auto;
        margin-right: auto;
        margin-top: 5px;
        margin-bottom: 5px;
      }
      .editQuestion textarea {
        height: 100px;
      }
      button.correctAnswer {
        background-color: #4CAF50; /* Green */
        color: white;

      }
      button.wrongAnswer {
        background-color: red;
        color: white;
      }
      p, pre {
        font-weight: bold;
      }
      pre {
        overflow-x: auto;
        white-space: pre-wrap;
        white-space: -moz-pre-wrap;
        white-space: -pre-wrap;
        white-space: -o-pre-wrap;
        word-wrap: break-word;
      }
      #navigation, .navigation input {
        text-align: center;
      }
      #navigation input {
        padding: 15px 32px;
        width: 80px;
      }
    </style>
    <script>
      "use strict";
      var singleton;
      var place;

      function reloadStorage() {
        var output = JSON.parse(window.localStorage.getItem("singleton"));
        if (output != null) {
          singleton = output;
        } else {
          singleton = {
            'data': [], //Data stores questions
            'list': [], //List stores the selected answer
          };
        }
        place = {
          'current': 0,
          'correct': 0,
          'failed': 0,
          'editMode': false,
          'showAllQuestions': false,
          'showAllControls': false
        };
        var list = singleton.list;
        var data = singleton.data;
        for (var i = 0; i < list.length; i++) {
          if (list[i] == undefined) {
            continue;
          }
          if (list[i] == data[i].answer) {
            place.correct++;
          } else {
            place.failed++;
          }
        }
        place.current = list.length   ;
      }

      function saveStorage() {
        window.localStorage.setItem("singleton", JSON.stringify(singleton));
      }

      //PWA handing
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('/sw.js').then(function(registration) {
            // Registration was successful
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          }, function(err) {
            // registration failed :(
            console.log('ServiceWorker registration failed: ', err);
          });
        });
      }

      function refreshCache() {
        caches.delete('Exam-questions').then(function(deleted) {
          if (!deleted) {
            alert("Cache not found");
          }
          location.reload();
        });
      }

      // Header functions
      function toggleControlsShow() {
        place.showAllControls=!place.showAllControls;
        refreshControls();
      }

      function toggleQuestionsShow() {
        place.showAllQuestions=!place.showAllQuestions;
        refreshPage();
      }

      function toggleEditMode() {
        place.editMode=!place.editMode;
        refreshPage();
      }

      function downloadAsFile() {
        var element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(window.localStorage.getItem("singleton")));
        element.setAttribute('download', 'singleton.json');
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
      }

      function uploadFile() {
        var files = document.getElementById('files').files;
        if (!files.length) {
          alert('Please select one file!');
          return;
        }
        var reader = new FileReader();
        reader.onloadend = function(evt) {
          if (evt.target.readyState == FileReader.DONE) {
            var fileContents = JSON.parse(evt.target.result); // Check we can parse the JSON
            singleton = fileContents; 
            saveStorage();
            initialize();
          }
        };
        reader.readAsText(files[0]);
      }

      function resetQuestions() {
        if (!confirm("If you continue, questions and progress will be completely lost. Are you sure?")) {
          return;
        }
        window.localStorage.removeItem("singleton");
        location.reload();
      }

      function resetAnswers() {
        if (!confirm("If you continue, your progress will be completely lost (questions will remain). Are you sure?")) {
          return;
        }
        singleton.list = [];
        saveStorage();
        location.reload();
      }

      function addQuestion() {
        singleton.data[singleton.data.length] = {
          "question": "",
          "possibilities": "",
          "answer": "",
          "explanation": "",
          "references": ""
        };
        place.current = singleton.data.length - 1;
        place.editMode = true;
        refreshPage();
        refreshNavigation();
      }

      function removeQuestion() {
        var questionId = place.current;
        if (!confirm("If you continue, this question will be deleted forever and you won't be able to undo")) {
          return;
        }
        //Last answer is singleton.list.length-1
        if (questionId < singleton.list.length) {
          singleton.list.splice(questionId, 1);
        }
        singleton.data.splice(questionId, 1);
        saveStorage();
        refreshPage();
      }

      // Q&A functions
      function answerQuestion(questionId, answer) {
        if (singleton.data[questionId].answer == answer) { 
          place.correct++;
        } else {
          place.failed++;
        }
        singleton.list[questionId] = answer;
        saveStorage();
        refreshPage();
      }

      function showQuestion(mainDiv, questionId) {
        var givenAnswer = singleton.list[questionId];
        var singleNode = document.createElement("div");
        var question = document.createElement("pre");
        question.appendChild(document.createTextNode(questionId.toString() + ". " + singleton.data[questionId].question));
        var possibilities = document.createElement("div");
        var lines = singleton.data[questionId].possibilities.split('\n');
        var buttons = [];
        for (var j = 0; j < lines.length; j++) {
          var button = document.createElement("button");
          button.setAttribute("answer", String.fromCharCode(65+j));
          button.onclick = function() {
            answerQuestion(this.parentElement.parentElement.getAttribute("questionId"), this.getAttribute("answer"));
          };
          button.appendChild(document.createTextNode(lines[j]));
          buttons[j] = button;
          possibilities.appendChild(button);
        }
        singleNode.setAttribute("class", "question");
        singleNode.setAttribute("questionId", questionId);
        singleNode.appendChild(question);
        singleNode.appendChild(possibilities);
        if (givenAnswer != undefined) {
          for (var i = 0; i < buttons.length; i++) {
            buttons[i].setAttribute("disabled", "true");
            if (singleton.data[questionId].answer == buttons[i].getAttribute("answer")) {
              buttons[i].classList.add("correctAnswer");
            } else if (buttons[i].getAttribute("answer") == givenAnswer) {
              buttons[i].classList.add("wrongAnswer");
            }
          }
          if (singleton.data[questionId].explanation != "") {
            var explanation = document.createElement("pre");
            explanation.appendChild(document.createTextNode(singleton.data[questionId].explanation));
            singleNode.appendChild(explanation);
          }
          if (singleton.data[questionId].references != "") {
            var references = document.createElement("p");
            var link = document.createElement("a");
            link.setAttribute("href", singleton.data[questionId].references);
            link.setAttribute("target", "_blank");
            link.appendChild(document.createTextNode(singleton.data[questionId].references));
            references.appendChild(link);
            singleNode.appendChild(references);
          }
        }
        mainDiv.appendChild(singleNode);
      }

      function showEditQuestion(mainDiv) {
        var questionId = place.current;
        var singleNode = document.createElement("div");
        singleNode.setAttribute("class", "editQuestion");
        var identifier = document.createElement("h2");
        identifier.appendChild(document.createTextNode(questionId.toString()));
        singleNode.appendChild(identifier);
        var question = document.createElement("textarea");
        question.setAttribute("id", "question");
        question.setAttribute("placeholder", "Question");
        question.appendChild(document.createTextNode(singleton.data[questionId].question));
        singleNode.appendChild(question);
        var possibilities = document.createElement("textarea");
        possibilities.setAttribute("id", "possibilities");
        possibilities.setAttribute("placeholder", "Possibilities");
        possibilities.appendChild(document.createTextNode(singleton.data[questionId].possibilities));
        singleNode.appendChild(possibilities);
        var answer = document.createElement("input");
        answer.setAttribute("type", "text");
        answer.setAttribute("id", "answer");
        answer.setAttribute("placeholder", "Answer");
        answer.setAttribute("value", singleton.data[questionId].answer);
        singleNode.appendChild(answer);
        var explanation = document.createElement("textarea");
        explanation.setAttribute("id", "explanation");
        explanation.setAttribute("placeholder", "Explanation");
        explanation.appendChild(document.createTextNode(singleton.data[questionId].explanation));
        singleNode.appendChild(explanation);
        var references = document.createElement("input");
        references.setAttribute("type", "text");
        references.setAttribute("id", "references");
        references.setAttribute("placeholder", "References");
        references.setAttribute("value", singleton.data[questionId].references);
        singleNode.appendChild(references);
        var submit = document.createElement("button");
        submit.setAttribute("onclick", "editQuestion()");
        submit.appendChild(document.createTextNode("Submit"));
        singleNode.appendChild(submit);
        mainDiv.appendChild(singleNode);
      }

      function editQuestion() {
        if (!confirm("If you continue, this question will be changed and you won't be able to undo")) {
          return;
        }
        var questionItems = ["question", "possibilities", "answer", "explanation", "references"];
        for (var i = 0; i < questionItems.length; i++) {
          singleton.data[place.current][questionItems[i]] = document.getElementById(questionItems[i]).value;
        }
        saveStorage();
        refreshPage();
      }

      function refreshControls() {
        if (!place.showAllControls) {
          document.getElementById('allControls').style.display='none';
        } else {
          document.getElementById('allControls').style.display='block';
        }
      }

      function refreshPage() {
        var mainDiv = document.getElementById("main");
        mainDiv.innerHTML = "";
        mainDiv.style.marginTop = (document.getElementsByTagName("header")[0].offsetHeight+15).toString()+"px";
        if (place.editMode) {
          showEditQuestion(mainDiv);
        } else if (place.showAllQuestions) {
          for (var i = 0; i < singleton.data.length; i++) {
            showQuestion(mainDiv, i);
          }
        } else if (singleton.data.length > 0) {
          console.log(place.current);
          showQuestion(mainDiv, place.current);
        }
        document.getElementById('correctCount').innerHTML = place.correct.toString();
        document.getElementById('wrongCount').innerHTML = place.failed.toString();
      }

      //Navigation
      function changeCurrentQuestion(newQuestionId) {
        if (newQuestionId >= singleton.data.length || newQuestionId < 0) {
          console.log("Question out of range");
          return;
        }
        place.current = newQuestionId;
        if (document.getElementById("navCurrentQuestion").value != place.current) {
          document.getElementById("navCurrentQuestion").value = place.current;
        }
        refreshPage();
      }

      function refreshNavigation() {
        var navNode = document.getElementById("navigation");
        navNode.setAttribute("class", "navigation");
        var buttonLeft = document.createElement("button");
        buttonLeft.appendChild(document.createTextNode("<"));
        buttonLeft.setAttribute("onclick", "changeCurrentQuestion(place.current-1)");
        navNode.appendChild(buttonLeft);
        var currentQuestion = document.createElement("input");
        currentQuestion.setAttribute("type", "text");
        currentQuestion.setAttribute("id", "navCurrentQuestion");
        currentQuestion.setAttribute("value", place.current.toString());
        currentQuestion.setAttribute("oninput", "changeCurrentQuestion(this.value)");
        navNode.appendChild(currentQuestion);
        var buttonRight = document.createElement("button");
        buttonRight.appendChild(document.createTextNode(">"));
        buttonRight.setAttribute("onclick", "changeCurrentQuestion(place.current+1)");
        navNode.appendChild(buttonRight);
      }

      function initialize() {
        reloadStorage();
        refreshPage();
        refreshControls();
        refreshNavigation();
      }
    </script>
  </head>
  <body onload="initialize()">
    <header>
      <p>
        Correct: <span id="correctCount">0</span>
        Wrong: <span id="wrongCount">0</span>
        <button onclick="toggleControlsShow()">Toggle controls</button>
      </p>
      <p id="allControls" style="display: none">
        <input type="file" id="files" name="file" oninput="uploadFile()" />
        <button onclick="downloadAsFile()">Backup</button>
        <button onclick="refreshCache()">Refresh cache</button>
        <button onclick="toggleQuestionsShow()">Show all questions</button>
        <!-- Creator zone -->
        <button onclick="toggleEditMode()" class="correctAnswer">Edit mode</button>
        <button onclick="addQuestion()" class="correctAnswer">Add question</button>
        <!-- Danger zone -->
        <button onclick="resetQuestions()" class="wrongAnswer">Reset questions</button>
        <button onclick="resetAnswers()" class="wrongAnswer">Reset answers</button>
        <button onclick="removeQuestion()" class="wrongAnswer">Remove current question</button>
      </p>
    </header>
    <div id="main"></div>
    <div id="navigation"></div>
  </body>
</html>
