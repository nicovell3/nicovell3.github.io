<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="white" />
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon.png">
    <title>Exam questions</title>
    <style>
      * {
        font-family: Arial, sans-serif;
      }
      body {
        height: 100%;
      }
      div.hidden {
        display: none
      }
      .question {
        display: block;
        border: 1px solid black;
        padding: 10px;
        margin: 10px;
      }
      button {
        margin: 5px;
        background-color: white;
        border: 1px solid black;
        padding: 15px 32px;
        text-align: center;
        text-decoration: none;
        cursor: pointer;
        display: inline-block;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
      }
      button:hover {
        box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.2);
      }
      button:disabled {
        background-color: #b7b7b7;
        box-shadow: 0 0 0 0 black;
        color: white;
        cursor: default;
      }
      button.correctAnswer {
        background-color: #4CAF50; /* Green */
      }
      button.wrongAnswer {
        background-color: red;
      }
      p {
        font-weight: bold;
      }
      header {
        position: fixed;
        background-color: white;
        top: 0;
        right: 0;
        width: 100%;
        box-shadow: 0 8px 8px 0 rgba(0, 0, 0, 0.2);
      }
      header button {
        padding: 5px 8px;
      }
      header p {
        margin: 10px 30px;
      }
    </style>
    <script>
      function getStorage(name) {
        var output = JSON.parse(window.localStorage.getItem(name));
        if (output != null) {
          return output;
        }
        if (name == "status") {
          return [0,0];
        } else {
          return [];
        }
      }

      function setStorage(name, value) {
        window.localStorage.setItem(name, JSON.stringify(value));
        console.log("written: "+name);
      }

      var develVar = "";
      var initializing = true;
      var showAllQuestions = false;
      var showAllControls = false;
      var data = getStorage("data");

      //PWA handing
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('/sw.js').then(function(registration) {
            // Registration was successful
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          }, function(err) {
            // registration failed :(
            console.log('ServiceWorker registration failed: ', err);
          });
        });
      }

      function refreshCache() {
        caches.delete('Exam-questions').then(function(deleted) {
          if (!deleted) {
            alert("Cache not found");
          }
          location.reload();
        });
      }

      function toggleControlsShow() {
        if (showAllControls) {
          document.getElementById('allControls').style.display='none';
        } else {
          document.getElementById('allControls').style.display='block';
        }
        showAllControls=!showAllControls;
      }

      function downloadAsFile(name) {
        var element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(window.localStorage.getItem(name)));
        element.setAttribute('download', name+'.json');
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
      }

      function uploadFile(name) {
        var files = document.getElementById('files').files;
        if (!files.length) {
          alert('Please select one file!');
          return;
        }
        var reader = new FileReader();
        reader.onloadend = function(evt) {
          if (evt.target.readyState == FileReader.DONE) {
            fileContents = JSON.parse(evt.target.result); // Check we can parse the JSON
            setStorage(name, fileContents);
            if (name == "data") {
              data = fileContents;
            }
            displayQuestions();
          }
        };
        reader.readAsText(files[0]);
      }

      function resetQuestions() {
        if (!confirm("If you continue, your progress will be completely lost. Are you sure?")) {
          return;
        }
        window.localStorage.removeItem("status");
        window.localStorage.removeItem("list");
        window.localStorage.removeItem("data");
        location.reload();
      }

      function addToCookie(questionId, answer, correct) {
        var list = getStorage("list")
        var status = getStorage("status");
        if (correct) { 
          status[0]++;
        } else {
          status[1]++;
        }
        list[questionId] = answer;
        setStorage("list", list);
        setStorage("status", status);
        showCounts();
      }

      function showCounts() {
        var status = getStorage("status");
        document.getElementById('correctCount').innerHTML = status[0].toString();
        document.getElementById('wrongCount').innerHTML = status[1].toString();
        if (data.length == 0 || showAllQuestions) {
          return;
        }
        var currentQuestion = status[0]+status[1];
        document.querySelector('[questionId="'+currentQuestion.toString()+'"]').classList.remove("hidden");
        if (currentQuestion > 1) {
          document.querySelector('[questionId="'+(currentQuestion -2).toString()+'"]').classList.add("hidden");
        }
      }

      function buttonSubmit() {
        var questionNode = this.parentElement.parentElement;
        var questionId=questionNode.getAttribute("questionId");
        var correct = data[questionId].answer == this.getAttribute("answer");
        if (!initializing) {
          addToCookie(questionId, this.getAttribute("answer"), correct);
        }
        if (correct) {
          this.classList.add("correctAnswer");
        } else {
          this.classList.add("wrongAnswer");
        }
        var buttons = questionNode.querySelectorAll("button");
        for (var i = 0; i < buttons.length; i++) {
          buttons[i].setAttribute("disabled", "true");
          if (data[questionId].answer == buttons[i].getAttribute("answer")) {
            buttons[i].classList.add("correctAnswer");
          }
        }
        if (data[questionId].explanation != "") {
          var explanation = document.createElement("p");
          explanation.appendChild(document.createTextNode(data[questionId].explanation));
          questionNode.appendChild(explanation);
        }
        if (data[questionId].references != "") {
          var references = document.createElement("p");
          references.appendChild(document.createTextNode(data[questionId].references));
          questionNode.appendChild(references);
        }
      }

      function displayQuestions() {
        var mainDiv = document.getElementById("main");
        initializing = true;
        mainDiv.innerHTML = "";
        mainDiv.style.marginTop = (document.getElementsByTagName("header")[0].offsetHeight+15).toString()+"px";
        for (var i = 0; i < data.length; i++) {
          var singleNode = document.createElement("div");
          var question = document.createElement("p");
          question.appendChild(document.createTextNode(i.toString() + ". " + data[i].question));
          var possibilities = document.createElement("div");
          lines = data[i].possibilities.split('\n');
          for (var j = 0; j < lines.length; j++) {
            var radio = document.createElement("button");
            radio.setAttribute("answer", String.fromCharCode(65+j));
            radio.onclick = buttonSubmit;
            radio.appendChild(document.createTextNode(lines[j]));
            possibilities.appendChild(radio);
          }
          singleNode.setAttribute("class", "question");
          singleNode.setAttribute("questionId", i);
          singleNode.appendChild(question);
          singleNode.appendChild(possibilities);
          if (!showAllQuestions) {
            singleNode.classList.add("hidden");
          }
          mainDiv.appendChild(singleNode);
        }
        var answerList = getStorage("list");
        for (var i = 0; i < answerList.length; i++) {
          var singleNode = document.querySelector('[questionId="'+i.toString()+'"');
          singleNode.querySelector('[answer="'+answerList[i]+'"').click();
        }
        showCounts();
        initializing = false;
      }
    </script>
  </head>
  <body onload="displayQuestions()">
    <header>
      <p>
        Correct: <span id="correctCount">0</span>
        Wrong: <span id="wrongCount">0</span>
        <button onclick="toggleControlsShow()">Toggle controls</button>
      </p>
      <p id="allControls" style="display: none">
        <select id="fileSelect">
          <option value="data">Data</option>
          <option value="list">List</option>
          <option value="status">Status</option>
        </select>
        <input type="file" id="files" name="file" oninput="uploadFile(document.getElementById('fileSelect').value)" />
        <button onclick="downloadAsFile(document.getElementById('fileSelect').value)">Backup</button>
        <button onclick="refreshCache()">Refresh cache</button>
        <button onclick="resetQuestions()">Reset questions</button>
        <button onclick="showAllQuestions=!showAllQuestions;displayQuestions()">Show all questions</button>
      </p>
    </header>
    <div id=main>
    </div>
  </body>
</html>
