<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="white" />
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon.png">
    <title>Exam questions</title>
    <style>
      * {
        font-family: Arial, sans-serif;
      }
      body {
        height: 100%;
      }
      div.hidden {
        display: none
      }
      .question {
        display: block;
        border: 1px solid black;
        padding: 10px;
        margin: 10px;
      }
      button {
        margin: 5px;
        background-color: white;
        border: 1px solid black;
        padding: 15px 32px;
        text-align: center;
        text-decoration: none;
        cursor: pointer;
        display: inline-block;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
      }
      button:hover {
        box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.2);
      }
      button:disabled {
        background-color: #b7b7b7;
        box-shadow: 0 0 0 0 black;
        color: white;
        cursor: default;
      }
      button.correctAnswer {
        background-color: #4CAF50; /* Green */
      }
      button.wrongAnswer {
        background-color: red;
      }
      p {
        font-weight: bold;
      }
      header {
        position: fixed;
        background-color: white;
        top: 0;
        right: 0;
        width: 100%;
        box-shadow: 0 8px 8px 0 rgba(0, 0, 0, 0.2);
      }
      header button {
        padding: 5px 8px;
      }
      header p {
        margin: 10px 30px;
      }
    </style>
    <script>
      "use strict";
      var singleton = {
        'data': [], //Data stores questions
        'list': [], //List stores the selected answer
        'config': {
          'showAllQuestions': false,
          'showAllControls': false
        }
      };
      var place = {
        'current': 0,
        'correct': 0,
        'failed': 0
      };
      var develVar = "";
      var initializing = true;

      function reloadStorage() {
        var output = JSON.parse(window.localStorage.getItem("singleton"));
        if (output != null) {
          singleton = output;
        } else {
          singleton = {
            'data': [], //Data stores questions
            'list': [], //List stores the selected answer
            'config': {
              'showAllQuestions': false,
              'showAllControls': false
            }
          };
        }
        place = {
          'current': 0,
          'correct': 0,
          'failed': 0
        };
        var list = singleton.list;
        var data = singleton.data;
        for (var i = 0; i < list.length; i++) {
          if (list[i] == undefined) {
            continue;
          }
          if (list[i] == data[i].answer) {
            place.correct++;
          } else {
            place.failed++;
          }
        }
        place.current = list.length   ;
      }

      function saveStorage() {
        window.localStorage.setItem("singleton", JSON.stringify(singleton));
        console.log("written: storage");
      }

      //PWA handing
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('/sw.js').then(function(registration) {
            // Registration was successful
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          }, function(err) {
            // registration failed :(
            console.log('ServiceWorker registration failed: ', err);
          });
        });
      }

      function refreshCache() {
        caches.delete('Exam-questions').then(function(deleted) {
          if (!deleted) {
            alert("Cache not found");
          }
          location.reload();
        });
      }

      function toggleControlsShow() {
        singleton.config.showAllControls=!singleton.config.showAllControls;
        refreshControls();
      }

      function toggleQuestionsShow() {
        singleton.config.showAllQuestions=!singleton.config.showAllQuestions;
        refreshPage();
      }

      function downloadAsFile() {
        var element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(window.localStorage.getItem(singleton)));
        element.setAttribute('download', 'singleton.json');
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
      }

      function uploadFile() {
        var files = document.getElementById('files').files;
        if (!files.length) {
          alert('Please select one file!');
          return;
        }
        var reader = new FileReader();
        reader.onloadend = function(evt) {
          if (evt.target.readyState == FileReader.DONE) {
            var fileContents = JSON.parse(evt.target.result); // Check we can parse the JSON
            singleton = fileContents; 
            saveStorage();
            initialize();
          }
        };
        reader.readAsText(files[0]);
      }

      function resetQuestions() {
        if (!confirm("If you continue, questions and progress will be completely lost. Are you sure?")) {
          return;
        }
        window.localStorage.removeItem("singleton");
        location.reload();
      }

      function answerQuestion(questionId, answer) {
        var correct = singleton.data[questionId].answer == answer;
        if (correct) { 
          place.correct++;
        } else {
          place.failed++;
        }
        place.current++;
        singleton.list[questionId] = answer;
        saveStorage();
        refreshPage();
      }

      function buttonSubmit() {
        var questionNode = this.parentElement.parentElement;
        var questionId = questionNode.getAttribute("questionId");
        answerQuestion(questionId, this.getAttribute("answer"));
      }

      function showQuestion(mainDiv, questionId) {
        var givenAnswer = singleton.list[questionId];
        console.log(questionId+" "+givenAnswer)
        var singleNode = document.createElement("div");
        var question = document.createElement("p");
        question.appendChild(document.createTextNode(questionId.toString() + ". " + singleton.data[questionId].question));
        var possibilities = document.createElement("div");
        var lines = singleton.data[questionId].possibilities.split('\n');
        var buttons = [];
        for (var j = 0; j < lines.length; j++) {
          var button = document.createElement("button");
          button.setAttribute("answer", String.fromCharCode(65+j));
          button.onclick = buttonSubmit;
          button.appendChild(document.createTextNode(lines[j]));
          buttons[j] = button;
          possibilities.appendChild(button);
        }
        singleNode.setAttribute("class", "question");
        singleNode.setAttribute("questionId", questionId);
        singleNode.appendChild(question);
        singleNode.appendChild(possibilities);
        if (givenAnswer != undefined) {
          for (var i = 0; i < buttons.length; i++) {
            buttons[i].setAttribute("disabled", "true");
            if (singleton.data[questionId].answer == buttons[i].getAttribute("answer")) {
              buttons[i].classList.add("correctAnswer");
            } else if (buttons[i].getAttribute("answer") == givenAnswer) {
              buttons[i].classList.add("wrongAnswer");
            }
          }

          if (singleton.data[questionId].explanation != "") {
            var explanation = document.createElement("p");
            explanation.appendChild(document.createTextNode(singleton.data[questionId].explanation));
            singleNode.appendChild(explanation);
          }
          if (singleton.data[questionId].references != "") {
            var references = document.createElement("p");
            var link = document.createElement("a");
            link.setAttribute("href", singleton.data[questionId].references);
            link.setAttribute("target", "_blank");
            link.appendChild(document.createTextNode(singleton.data[questionId].references));
            references.appendChild(link);
            singleNode.appendChild(references);
          }
        }
        mainDiv.appendChild(singleNode);
      }

      function refreshControls() {
        if (singleton.config.showAllControls) {
          document.getElementById('allControls').style.display='none';
        } else {
          document.getElementById('allControls').style.display='block';
        }
      }

      function refreshPage() {
        var mainDiv = document.getElementById("main");
        mainDiv.innerHTML = "";
        mainDiv.style.marginTop = (document.getElementsByTagName("header")[0].offsetHeight+15).toString()+"px";
        if (singleton.config.showAllQuestions) {
          for (var i = 0; i < singleton.data.length; i++) {
            showQuestion(mainDiv, i);
          }
        } else if (singleton.data.length > 0) {
          console.log(place.current);
          if (place.current > 0) {
            showQuestion(mainDiv, place.current-1);
          }
          showQuestion(mainDiv, place.current);
        }
        document.getElementById('correctCount').innerHTML = place.correct.toString();
        document.getElementById('wrongCount').innerHTML = place.failed.toString();
      }

      function initialize() {
        reloadStorage();
        refreshPage();
        refreshControls();
      }
    </script>
  </head>
  <body onload="initialize()">
    <header>
      <p>
        Correct: <span id="correctCount">0</span>
        Wrong: <span id="wrongCount">0</span>
        <button onclick="toggleControlsShow()">Toggle controls</button>
      </p>
      <p id="allControls" style="display: none">
        <input type="file" id="files" name="file" oninput="uploadFile()" />
        <button onclick="downloadAsFile()">Backup</button>
        <button onclick="refreshCache()">Refresh cache</button>
        <button onclick="resetQuestions()">Reset questions</button>
        <button onclick="toggleQuestionsShow()">Show all questions</button>
      </p>
    </header>
    <div id=main>
    </div>
  </body>
</html>
